<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 问卷 dao -->
<mapper namespace="dao.NewQuizDao">
    <sql id="quiz_columns">
        `quiz_id`, `class_id`, `user_id`, `course_id`, `date`, `quiz_detail_id`
    </sql>

    <sql id="quiz_detail">
        SELECT
            qd.quiz_detail_id,
            qd.is_used,
            qq.question
        FROM quiz_detail qd INNER JOIN quiz_question qq ON qd.quiz_detail_id = qq.quiz_detail_id
    </sql>

    <resultMap id="quiz_detail_map" type="entity.QuizDetail">
        <id property="quizDetailId" column="quiz_detail_id" />
        <result property="isUsed" column="is_used" />
        <collection property="questions" ofType="entity.QuizQuestion">
            <result property="question" column="question" />
        </collection>
    </resultMap>

    <select id="getQuizByUserIdOrCourseId" resultType="entity.Quiz">
        SELECT <include refid="quiz_columns" />
        FROM quiz
        <where>
            <if test="1">
                user_id = #{userId}
            </if>
            <if test="courseId != null"><!-- 如果有 courseId，就加上 -->
                AND course_id = #{courseId}
            </if>
        </where>
    </select>

    <select id="getQuestionsByQuizDetailId" resultType="string">
        SELECT question
        FROM quiz_question
        WHERE quiz_detail_id = #{quizDetailId}
    </select>

    <select id="getAnswersByQuizId" resultType="string">
        SELECT quiz_answer
        FROM quiz_answer
        WHERE quiz_id = #{quizId}
    </select>

    <select id="getQuizByClassIdOrCourseId" resultType="entity.Quiz">
        SELECT <include refid="quiz_columns" />
        FROM quiz
        <where>
            1 = 1
            <if test="classId != null">
                AND class_id = #{classId}
            </if>
            <if test="courseId != null">
                AND course_id = #{courseId}
            </if>
        </where>
    </select>

    <select id="getQuizes" resultMap="quiz_detail_map">
        <include refid="quiz_detail" />
    </select>

    <select id="getQuiz" resultMap="quiz_detail_map">
        <include refid="quiz_detail"/>
        WHERE qd.is_used = 1;
    </select>

    <select id="getQuizByHisClassIdOrCourseId" resultType="java.util.Map">
        /* TODO sql 语句还没写 */
    </select>

    <insert id="insertQuiz" useGeneratedKeys="true" keyProperty="quizId">
        INSERT INTO quiz(class_id, user_id, course_id, date, quiz_detail_id)
        VALUES(#{classId}, #{userId}, #{courseId}, #{date}, #{quizDetailId})
    </insert>

    <insert id="insertQuizAnswer">
        INSERT INTO quiz_answer(quiz_answer, quiz_id)
        VALUES
        <foreach collection="answers" item="answer" separator=",">
            (#{answer}, #{quizId})
        </foreach>
    </insert>

    <insert id="insertQuizDetail" useGeneratedKeys="true" keyProperty="quizDetailId">
        INSERT INTO quiz_detail(quiz_create_date, quiz_update_date, is_used)
        VALUES(NOW(), NOW(), #{isUsed})
    </insert>

    <insert id="insertQuizQuestion">
        INSERT INTO quiz_question(question, quiz_detail_id)
        VALUES
        <foreach collection="questions" item="question" separator=",">
            (#{question.question}, #{quizDetailId})
        </foreach>
    </insert>
</mapper>